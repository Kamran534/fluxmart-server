<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Auth GraphQL Testing Guide</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; color: #111; line-height: 1.55; }
    h1,h2,h3 { margin: 16px 0 8px; }
    p { margin: 8px 0; }
    ul { margin: 6px 0 12px 20px; }
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    pre { background: #0b1020; color: #e6e6e6; padding: 12px; overflow: auto; border-radius: 6px; }
    .hint { color: #444; }
    .section { margin-bottom: 20px; }
    .hdr { background:#f7f7f7; padding: 8px 10px; border: 1px solid #e5e5e5; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Auth GraphQL Testing Guide</h1>

  <div class="section">
    <div class="hdr"><strong>Endpoint</strong></div>
    <p>URL: <code>http://localhost:${PORT}/graphql</code> (default <code>http://localhost:8080/graphql</code>)</p>
  </div>

  <div class="section">
    <div class="hdr"><strong>Headers</strong></div>
    <ul>
      <li><code>Content-Type: application/json</code></li>
      <li><code>Authorization: Bearer &lt;accessToken&gt;</code> (for me/logout; not needed for register/login/refresh)</li>
    </ul>
  </div>

  <div class="section">
    <div class="hdr"><strong>How to add the token to headers</strong></div>
    <h3>cURL</h3>
    <pre>curl -X POST http://localhost:8080/graphql \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer &lt;accessToken&gt;" \
  -d '{ "query": "{ me { id email } }" }'</pre>

    <h3>Postman</h3>
    <ul>
      <li>Go to the <strong>Headers</strong> tab and add: <code>Authorization</code> = <code>Bearer &lt;accessToken&gt;</code></li>
      <li>Or in <strong>Authorization</strong> tab, choose <em>Bearer Token</em> and paste the access token.</li>
    </ul>

    <h3>Apollo Sandbox / GraphQL Playground</h3>
    <ul>
      <li>Open the <strong>Headers</strong> panel (usually on the left/right sidebar).</li>
      <li>Add JSON headers, for example:</li>
    </ul>
    <pre>{
  "Authorization": "Bearer &lt;accessToken&gt;",
  "Content-Type": "application/json"
}</pre>
  </div>

  <h2>Quick Requests (POST /graphql)</h2>

  <h3>Register</h3>
  <pre>{
  "query": "mutation Register($input: RegisterInput!){ register(input: $input){ user { id email name roles addresses { label line1 city country isDefault } createdAt updatedAt } tokens { accessToken refreshToken } } }",
  "variables": {
    "input": { "email": "alice@example.com", "password": "Passw0rd!", "name": "Alice" }
  }
}</pre>

  <h3>Login</h3>
  <pre>{
  "query": "mutation Login($input: LoginInput!){ login(input: $input){ user { id email name roles addresses { label line1 city country isDefault } } tokens { accessToken refreshToken } } }",
  "variables": {
    "input": { "email": "alice@example.com", "password": "Passw0rd!" }
  }
}</pre>

  <h3>Me (requires accessToken)</h3>
  <pre>{
  "query": "query Me { me { id email name roles addresses { label line1 city country isDefault } profileImageUrl createdAt updatedAt } }"
}</pre>

  <h3>Refresh Token</h3>
  <pre>{
  "query": "mutation Refresh($token: String!){ refreshToken(refreshToken: $token){ accessToken refreshToken } }",
  "variables": { "token": "&lt;refreshToken&gt;" }
}</pre>

  <h3>Logout (requires accessToken)</h3>
  <pre>{
  "query": "mutation { logout }"
}</pre>

  <h3>Password Reset: Request</h3>
  <pre>{
  "query": "mutation RequestPasswordReset($email: String!){ requestPasswordReset(email: $email) }",
  "variables": { "email": "alice@example.com" }
}</pre>

  <h3>Password Reset: Confirm</h3>
  <pre>{
  "query": "mutation ResetPassword($token: String!, $pwd: String!){ resetPassword(token: $token, newPassword: $pwd) }",
  "variables": { "token": "<tokenFromEmail>", "pwd": "NewPassw0rd!" }
}</pre>

  <h3>Profile Image: Get Presigned Upload URL (requires accessToken)</h3>
  <pre>{
  "query": "mutation PresignUpload($input: PresignProfileImageInput!){ presignProfileImageUpload(input: $input){ url key } }",
  "variables": { "input": { "contentType": "image/jpeg", "fileExtension": "jpg" } }
}</pre>

  <h3>Profile Image: Set Profile Image (requires accessToken)</h3>
  <pre>{
  "query": "mutation SetProfileImage($key: String!){ setProfileImage(key: $key){ id email name profileImageUrl } }",
  "variables": { "key": "users/123/profile/1234567890.jpg" }
}</pre>

  <h3>Profile Image: Get Presigned View URL (requires accessToken)</h3>
  <pre>{
  "query": "mutation PresignView($key: String!){ presignProfileImageView(key: $key){ url expiresIn } }",
  "variables": { "key": "users/123/profile/1234567890.jpg" }
}</pre>

  <h2>GraphQL Operations (copy/paste)</h2>

  <h3>Register</h3>
  <pre>mutation Register($input: RegisterInput!) {
  register(input: $input) {
    user {
      id
      email
      name
      roles
      addresses { label line1 city country isDefault }
      createdAt
      updatedAt
    }
    tokens {
      accessToken
      refreshToken
    }
  }
}</pre>

  <h4>Variables</h4>
  <pre>{
  "input": {
    "email": "alice@example.com",
    "password": "Passw0rd!",
    "name": "Alice"
  }
}</pre>

  <h3>Login</h3>
  <pre>mutation Login($input: LoginInput!) {
  login(input: $input) {
    user { id email name roles addresses { label line1 city country isDefault } }
    tokens { accessToken refreshToken }
  }
}</pre>

  <h4>Variables</h4>
  <pre>{
  "input": { "email": "alice@example.com", "password": "Passw0rd!" }
}</pre>

  <h3>Me</h3>
  <pre>query Me {
  me { 
    id 
    email 
    name 
    roles
    addresses { label line1 city country isDefault }
    profileImageUrl
    createdAt 
    updatedAt 
  }
}</pre>

  <h3>Refresh Token</h3>
  <pre>mutation Refresh($token: String!) {
  refreshToken(refreshToken: $token) {
    accessToken
    refreshToken
  }
}</pre>

  <h4>Variables</h4>
  <pre>{
  "token": "&lt;refreshToken&gt;"
}</pre>

  <h3>Logout</h3>
  <pre>mutation {
  logout
}</pre>

  <h2>Password Reset</h2>
  <h3>Request Password Reset</h3>
  <pre>mutation RequestPasswordReset($email: String!) {
  requestPasswordReset(email: $email)
}</pre>

  <h4>Variables</h4>
  <pre>{
  "email": "alice@example.com"
}</pre>

  <h3>Reset Password</h3>
  <pre>mutation ResetPassword($token: String!, $newPassword: String!) {
  resetPassword(token: $token, newPassword: $newPassword)
}</pre>

  <h4>Variables</h4>
  <pre>{
  "token": "<tokenFromEmail>",
  "newPassword": "NewPassw0rd!"
}</pre>

  <h2>Email OTP</h2>
  <h3>Request Email OTP</h3>
  <pre>mutation RequestEmailOTP($email: String!) {
  requestEmailOTP(email: $email)
}</pre>

  <h4>Variables</h4>
  <pre>{
  "email": "alice@example.com"
}</pre>

  <h3>Verify Email OTP</h3>
  <pre>mutation VerifyEmailOTP($email: String!, $otp: String!) {
  verifyEmailOTP(email: $email, otp: $otp) {
    user { id email name roles addresses { label line1 city country isDefault } isEmailVerified }
    tokens { accessToken refreshToken }
  }
}</pre>

  <h4>Variables</h4>
  <pre>{
  "email": "alice@example.com",
  "otp": "123456"
}</pre>

  <h2>Profile Image Management</h2>
  
  <h3>Get Presigned Upload URL</h3>
  <pre>mutation PresignProfileImageUpload($input: PresignProfileImageInput!) {
  presignProfileImageUpload(input: $input) {
    url
    key
  }
}</pre>

  <h4>Variables</h4>
  <pre>{
  "input": {
    "contentType": "image/jpeg",
    "fileExtension": "jpg"
  }
}</pre>

  <h3>Set Profile Image</h3>
  <pre>mutation SetProfileImage($key: String!) {
  setProfileImage(key: $key) {
    id
    email
    name
    profileImageUrl
  }
}</pre>

  <h4>Variables</h4>
  <pre>{
  "key": "users/123/profile/1234567890.jpg"
}</pre>

  <h3>Get Presigned View URL</h3>
  <pre>mutation PresignProfileImageView($key: String!) {
  presignProfileImageView(key: $key) {
    url
    expiresIn
  }
}</pre>

  <h4>Variables</h4>
  <pre>{
  "key": "users/123/profile/1234567890.jpg"
}</pre>

  <h3>View Image via Express Proxy (always private)</h3>
  <p>There are two ways to proxy an image from S3 through the server:</p>
  <ul>
    <li><strong>Query param variant (Swagger-friendly)</strong>: <code>GET /api/image?key=users/123/profile/image.jpg</code></li>
    <li><strong>Path param variant</strong>: <code>GET /api/image/{key}</code> with URL-encoded slashes, e.g. <code>users%2F123%2Fprofile%2Fimage.jpg</code></li>
  </ul>

  <h4>Swagger usage</h4>
  <ul>
    <li>Open <code>/api-docs</code> and go to the <strong>Images</strong> tag.</li>
    <li>Prefer <strong>GET /api/image</strong> and pass <code>key</code> as a query param to avoid URL-encoding.</li>
    <li>Add <code>Authorization: Bearer &lt;accessToken&gt;</code> in the Authorize dialog.</li>
  </ul>

  <p class="hint"><strong>Note:</strong> Swagger UI typically does not inline-render binary image responses. You'll see a successful 200 and headers, and can click the download button to save/open the image. To view inline, open the URL in a new browser tab using your JWT in the <code>Authorization</code> header or <code>?token=&lt;accessToken&gt;</code> query param.</p>

  <h4>cURL — Query param variant</h4>
  <pre>curl -X GET "http://localhost:8080/api/image?key=users/123/profile/1234567890.jpg" \
  -H "Authorization: Bearer &lt;accessToken&gt;" \
  -H "Accept: image/*" --output image.jpg</pre>

  <h4>cURL — Path param variant (URL-encoded key)</h4>
  <pre>curl -X GET "http://localhost:8080/api/image/users%2F123%2Fprofile%2F1234567890.jpg" \
  -H "Authorization: Bearer &lt;accessToken&gt;" \
  -H "Accept: image/*" --output image.jpg</pre>

  <h2>Address Management (requires accessToken)</h2>
  <h3>Add Address</h3>
  <pre>{
  "query": "mutation Add($input: AddressInput!){ addAddress(input: $input){ id email roles addresses { label line1 city country isDefault } } }",
  "variables": {
    "input": {
      "label": "Home",
      "line1": "123 Main St",
      "city": "Springfield",
      "state": "IL",
      "postalCode": "62704",
      "country": "US",
      "isDefault": true
    }
  }
}</pre>

  <h3>Update Address</h3>
  <pre>{
  "query": "mutation Upd($index:Int!, $input: AddressInput!){ updateAddress(index:$index, input:$input){ addresses { label line1 city state postalCode country isDefault } } }",
  "variables": { "index": 0, "input": { "label": "Home", "line2": "Apt 4B" } }
}</pre>

  <h3>Remove Address</h3>
  <pre>{
  "query": "mutation Rem($index:Int!){ removeAddress(index:$index){ addresses { label line1 city country isDefault } } }",
  "variables": { "index": 0 }
}</pre>

  <h3>Set Default Address</h3>
  <pre>{
  "query": "mutation Def($index:Int!){ setDefaultAddress(index:$index){ addresses { label line1 city country isDefault } } }",
  "variables": { "index": 1 }
}</pre>

  <h3>Address Operations for Apollo Sandbox / GraphQL Playground</h3>
  <p>Copy the operation into the editor and the variables into the <strong>Variables</strong> panel. Ensure you have set the <code>Authorization</code> header with a valid access token.</p>

  <h4>Add Address — Operation</h4>
  <pre>mutation AddAddress($input: AddressInput!) {
  addAddress(input: $input) {
    id
    email
    roles
    addresses { label line1 line2 city state postalCode country isDefault }
  }
}</pre>

  <h4>Add Address — Variables</h4>
  <pre>{
  "input": {
    "label": "Home",
    "line1": "123 Main St",
    "line2": "",
    "city": "Springfield",
    "state": "IL",
    "postalCode": "62704",
    "country": "US",
    "isDefault": true
  }
}</pre>

  <h4>Update Address — Operation</h4>
  <pre>mutation UpdateAddress($index: Int!, $input: AddressInput!) {
  updateAddress(index: $index, input: $input) {
    addresses { label line1 line2 city state postalCode country isDefault }
  }
}</pre>

  <h4>Update Address — Variables</h4>
  <pre>{
  "index": 0,
  "input": { "label": "Home", "line2": "Apt 4B" }
}</pre>

  <h4>Remove Address — Operation</h4>
  <pre>mutation RemoveAddress($index: Int!) {
  removeAddress(index: $index) {
    addresses { label line1 city country isDefault }
  }
}</pre>

  <h4>Remove Address — Variables</h4>
  <pre>{ "index": 0 }</pre>

  <h4>Set Default Address — Operation</h4>
  <pre>mutation SetDefaultAddress($index: Int!) {
  setDefaultAddress(index: $index) {
    addresses { label line1 city country isDefault }
  }
}</pre>

  <h4>Set Default Address — Variables</h4>
  <pre>{ "index": 1 }</pre>

  <h2>Role Management (admin only, requires accessToken)</h2>
  <p>Only users with <code>admin</code> role can update roles.</p>
  <h3>Set Roles — Operation</h3>
  <pre>mutation SetRoles($userId: ID!, $roles: [String!]!) {
  setRoles(userId: $userId, roles: $roles) {
    id
    email
    roles
  }
}</pre>
  <h3>Set Roles — Variables</h3>
  <pre>{
  "userId": "<targetUserId>",
  "roles": ["customer", "admin"]
}</pre>

  <h2>cURL Examples</h2>
  <h3>Login</h3>
  <pre>curl -X POST http://localhost:8080/graphql \
  -H "Content-Type: application/json" \
  -d '{
    "query": "mutation($input: LoginInput!){ login(input: $input){ user { id email roles } tokens { accessToken refreshToken } } }",
    "variables": { "input": { "email": "alice@example.com", "password": "Passw0rd!" } }
  }'</pre>

  <h3>Me</h3>
  <pre>curl -X POST http://localhost:8080/graphql \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer &lt;accessToken&gt;" \
  -d '{ "query": "{ me { id email name roles addresses { label line1 city country isDefault } profileImageUrl } }" }'</pre>

  <h2>User Fields Reference</h2>
  <ul>
    <li><code>roles</code>: array of strings. Default <code>["customer"]</code>. Example: <code>["customer","admin"]</code></li>
    <li><code>addresses</code>: array of address objects with fields: <code>label</code>, <code>line1</code>, <code>line2</code>, <code>city</code>, <code>state</code>, <code>postalCode</code>, <code>country</code>, <code>isDefault</code></li>
  </ul>

  <h3>Profile Image Upload (cURL)</h3>
  <pre># Step 1: Get presigned upload URL
curl -X POST http://localhost:8080/graphql \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer &lt;accessToken&gt;" \
  -d '{
    "query": "mutation($input: PresignProfileImageInput!){ presignProfileImageUpload(input: $input){ url key } }",
    "variables": { "input": { "contentType": "image/jpeg" } }
  }'

# Step 2: Upload file to the presigned URL (use the 'url' from step 1)
curl -X PUT "&lt;presignedUrl&gt;" \
  -H "Content-Type: image/jpeg" \
  --data-binary @image.jpg

# Step 3: Set profile image (use the 'key' from step 1)
curl -X POST http://localhost:8080/graphql \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer &lt;accessToken&gt;" \
  -d '{
    "query": "mutation($key: String!){ setProfileImage(key: $key){ id profileImageUrl } }",
    "variables": { "key": "&lt;keyFromStep1&gt;" }
  }'</pre>

  <h3>Password Reset (cURL)</h3>
  <pre># Request
curl -X POST http://localhost:8080/graphql \
  -H "Content-Type: application/json" \
  -d '{
    "query": "mutation($email:String!){ requestPasswordReset(email:$email) }",
    "variables": { "email": "alice@example.com" }
  }'

# Confirm
curl -X POST http://localhost:8080/graphql \
  -H "Content-Type: application/json" \
  -d '{
    "query": "mutation($t:String!,$p:String!){ resetPassword(token:$t, newPassword:$p) }",
    "variables": { "t": "<tokenFromEmail>", "p": "NewPassw0rd!" }
  }'</pre>

  <p class="hint">Password reset link expires after <code>RESET_TTL_HOURS</code> (default 1h). Frontend link base is <code>FRONTEND_BASE_URL</code> or defaults to <code>https://fluxmart.com</code>.</p>

  <p class="hint"><strong>Profile Images:</strong> Images are stored in private S3 bucket. Use presigned URLs for uploads and viewing. Express proxy available at <code>/api/image/:key</code> with JWT authentication. Supported formats: JPEG, PNG, WebP, GIF.</p>

  <p class="hint">Notes: Keep <code>JWT_ACCESS_TTL_SEC</code> short (e.g., 900s) and rotate refresh on every refresh call. On password change or security events, increment <code>user.tokenVersion</code> or revoke all refresh tokens.</p>
</body>
</html>

